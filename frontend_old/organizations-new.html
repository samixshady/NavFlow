<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizations - NavFlow</title>
    <link rel="stylesheet" href="styles-clean.css">
</head>
<body class="dashboard-page">
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="logo">NavFlow</h1>
            <div class="nav-right">
                <span id="userEmail" class="user-email"></span>
                <button id="logoutBtn" class="btn btn-logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <a href="dashboard-new.html" class="nav-item">
                    <span class="icon">üìä</span> Dashboard
                </a>
                <a href="organizations-new.html" class="nav-item active">
                    <span class="icon">üè¢</span> Organizations
                </a>
                <a href="projects-new.html" class="nav-item">
                    <span class="icon">üìã</span> Projects
                </a>
                <a href="tasks-new.html" class="nav-item">
                    <span class="icon">‚úì</span> Tasks
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Messages -->
            <div id="successMessage" class="alert alert-success" style="display: none;">
                ‚úÖ <span id="successText"></span>
            </div>
            <div id="errorMessage" class="alert alert-error" style="display: none;">
                ‚ùå <span id="errorText"></span>
            </div>

            <!-- Create Organization Form -->
            <div class="card">
                <h2>Create Organization</h2>
                <form id="createOrgForm" class="form" onsubmit="event.preventDefault(); createOrganization();">
                    <div class="form-group">
                        <label for="orgName">Organization Name *</label>
                        <input type="text" id="orgName" required placeholder="Acme Corp">
                    </div>
                    <div class="form-group">
                        <label for="orgDescription">Description (Optional)</label>
                        <textarea id="orgDescription" rows="3" placeholder="What does your organization do?"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Organization</button>
                </form>
            </div>

            <!-- Organizations List -->
            <div class="card">
                <h2>My Organizations</h2>
                <div id="orgsList" class="grid-2">
                    <p class="loading">Loading organizations...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Organization Detail Modal -->
    <div id="orgModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalOrgName">Organization Details</h2>
                <button type="button" class="modal-close">&times;</button>
            </div>

            <!-- Organization Info -->
            <div id="orgInfo" class="section"></div>

            <!-- Members Section -->
            <div class="section">
                <h3>Members</h3>
                <div id="membersList" class="list">
                    <p class="loading">Loading members...</p>
                </div>
            </div>

            <!-- Add Member Section (only for Admin/Owner) -->
            <div id="addMemberSection" class="section" style="display: none;">
                <h3>Invite Member</h3>
                <form id="inviteMemberForm" class="form" onsubmit="event.preventDefault(); inviteMember();">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="memberEmail">Email Address *</label>
                            <input type="email" id="memberEmail" required placeholder="member@example.com">
                        </div>
                        <div class="form-group">
                            <label for="memberRole">Role *</label>
                            <select id="memberRole" required>
                                <option value="member">Member</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="margin-top: 28px;">Invite</button>
                    </div>
                </form>
            </div>

            <!-- Pending Invites -->
            <div class="section" id="pendingInvitesSection" style="display: none;">
                <h3>Pending Invitations</h3>
                <div id="pendingInvitesList" class="list"></div>
            </div>
        </div>
    </div>

    <script src="app-clean.js"></script>
    <script>
        let selectedOrgId = null;

        async function initPage() {
            CURRENT_USER = await getCurrentUser();
            if (!CURRENT_USER) {
                window.location.href = 'login-new.html';
                return;
            }

            await loadOrganizations();
        }

        async function createOrganization() {
            const name = document.getElementById('orgName')?.value.trim();
            const description = document.getElementById('orgDescription')?.value.trim() || '';

            if (!name) {
                showError('Organization name is required');
                return;
            }

            try {
                const data = await apiRequest('/orgs/', 'POST', {
                    name,
                    description
                });

                showSuccess('Organization created!');
                document.getElementById('createOrgForm').reset();
                await loadOrganizations();
            } catch (error) {
                showError(error.message);
            }
        }

        async function loadOrganizations() {
            try {
                showLoading('orgsList');
                const data = await apiRequest('/orgs/', 'GET');
                const orgs = data.results || [];

                if (orgs.length === 0) {
                    document.getElementById('orgsList').innerHTML = '<p class="empty">No organizations yet. Create one above!</p>';
                    return;
                }

                const html = orgs.map(org => `
                    <div class="org-card card" onclick="openOrgModal(${org.id})">
                        <h3>${org.name}</h3>
                        <p>${org.description || 'No description'}</p>
                        <div class="org-meta">
                            <span class="badge">${org.member_count || 0} members</span>
                        </div>
                        <button class="btn btn-small btn-primary">View Details ‚Üí</button>
                    </div>
                `).join('');

                document.getElementById('orgsList').innerHTML = html;
            } catch (error) {
                console.error('Failed to load orgs:', error);
                showError('Failed to load organizations');
            }
        }

        async function openOrgModal(orgId) {
            selectedOrgId = orgId;
            try {
                const org = await apiRequest(`/orgs/${orgId}/`, 'GET');
                document.getElementById('modalOrgName').textContent = org.name;
                document.getElementById('orgInfo').innerHTML = `<p>${org.description || 'No description'}</p>`;

                // Load members
                const members = org.members || [];
                const memberHtml = members.map(m => `
                    <div class="member-item">
                        <strong>${m.user_email}</strong>
                        <span class="role-badge">${m.role}</span>
                    </div>
                `).join('') || '<p>No members</p>';

                document.getElementById('membersList').innerHTML = memberHtml;

                // Show add member section if user is admin/owner
                const canManage = members.some(m => 
                    m.user_email === CURRENT_USER?.email && 
                    (m.role === 'admin' || m.role === 'owner')
                );

                document.getElementById('addMemberSection').style.display = canManage ? 'block' : 'none';
                document.getElementById('inviteMemberForm').reset();

                // Show pending invites if any
                // TODO: Fetch pending invites from API

                openModal('orgModal');
            } catch (error) {
                showError('Failed to load organization');
            }
        }

        async function inviteMember() {
            const email = document.getElementById('memberEmail')?.value.trim();
            const role = document.getElementById('memberRole')?.value;

            if (!email || !role) {
                showError('Email and role required');
                return;
            }

            try {
                // TODO: Add member to organization via API
                // await apiRequest(`/organizations/${selectedOrgId}/members/`, 'POST', { email, role });
                showSuccess('Invitation sent!');
                document.getElementById('inviteMemberForm').reset();
            } catch (error) {
                showError(error.message);
            }
        }
    </script>
</body>
</html>
